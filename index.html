<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Scheduling</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Load employees from localStorage and update the schedule
        function loadEmployees() {
            // Check if an update flag exists from payrate.html
            if (localStorage.getItem("updateSchedule") === "true") {
                localStorage.removeItem("updateSchedule"); // Reset the flag
            }

            let employees = JSON.parse(localStorage.getItem("employees")) || [];
            let savedSchedule = JSON.parse(localStorage.getItem("employeeSchedule")) || [];
            let tableBody = document.querySelector("tbody");

            tableBody.innerHTML = ""; // Clear existing rows

            employees.forEach(emp => {
                let savedEmployee = savedSchedule.find(e => e.name === emp.name) || { times: [] };

                let row = document.createElement("tr");
                row.classList.add("employee-row");
                row.setAttribute("data-normal-pay", emp.normalPay);
                row.setAttribute("data-sat-pay", emp.satPay);
                row.setAttribute("data-sun-pay", emp.sunPay);

                let nameCell = document.createElement("td");
                nameCell.innerText = emp.name;
                row.appendChild(nameCell);

                for (let i = 0; i < 7; i++) {
                    let cell = document.createElement("td");
                    let startInput = document.createElement("input");
                    startInput.type = "time";
                    startInput.classList.add(`start${i}`);
                    startInput.value = savedEmployee.times[i]?.start || "";

                    let endInput = document.createElement("input");
                    endInput.type = "time";
                    endInput.classList.add(`end${i}`);
                    endInput.value = savedEmployee.times[i]?.end || "";

                    cell.appendChild(startInput);
                    cell.appendChild(document.createTextNode(" - "));
                    cell.appendChild(endInput);
                    row.appendChild(cell);
                }

                let normalHoursCell = document.createElement("td");
                normalHoursCell.classList.add("normal-hours");
                row.appendChild(normalHoursCell);

                let normalPayCell = document.createElement("td");
                normalPayCell.classList.add("normal-pay");
                row.appendChild(normalPayCell);

                let satHoursCell = document.createElement("td");
                satHoursCell.classList.add("sat-hours");
                row.appendChild(satHoursCell);

                let satPayCell = document.createElement("td");
                satPayCell.classList.add("sat-pay");
                row.appendChild(satPayCell);

                let sunHoursCell = document.createElement("td");
                sunHoursCell.classList.add("sun-hours");
                row.appendChild(sunHoursCell);

                let sunPayCell = document.createElement("td");
                sunPayCell.classList.add("sun-pay");
                row.appendChild(sunPayCell);

                let totalHoursCell = document.createElement("td");
                totalHoursCell.classList.add("total-hours");
                row.appendChild(totalHoursCell);

                let totalPayrollCell = document.createElement("td");
                totalPayrollCell.classList.add("total-payroll");
                row.appendChild(totalPayrollCell);

                tableBody.appendChild(row);
            });

            calculatePayroll();  // Calculate payroll on initial load
        }

        // Function to generate PDF of the schedule in the table format
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPosition = 20;

            // Set up the table headers
            const headers = ['Employee', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            // Create the table in the PDF
            doc.setFontSize(12);
            doc.autoTable({
                head: [headers],
                body: [],
                startY: yPosition,
                theme: 'grid',
                headStyles: { fillColor: [0, 100, 255] },
                margin: { top: 20, left: 10, right: 10 },
            });

            // Loop through the employee rows to add data (employee names and schedules)
            const rows = document.querySelectorAll(".employee-row");
            rows.forEach(row => {
                const name = row.querySelector("td").innerText;
                let schedule = [];
                for (let i = 0; i < 7; i++) {
                    const startInput = row.querySelector(`.start${i}`);
                    const endInput = row.querySelector(`.end${i}`);
                    if (startInput.value && endInput.value) {
                        schedule.push(`${startInput.value} - ${endInput.value}`);
                    } else {
                        schedule.push('');
                    }
                }

                // Add the row to the table in the PDF
                doc.autoTable({
                    body: [[name, ...schedule]],
                    startY: doc.lastAutoTable.finalY + 10,
                    theme: 'grid',
                    margin: { top: 10, left: 10, right: 10 },
                });
            });

            // Save the PDF with the name "Employee_Schedule.pdf"
            doc.save("Employee_Schedule.pdf");
        }

        // Load schedule on page load
        window.onload = function () {
            let savedStartDate = localStorage.getItem("startDate");
            if (savedStartDate) {
                document.getElementById("start-date").value = savedStartDate;
            }
            loadEmployees();
        };
    </script>
</head>
<body>

    <h2>Employee Scheduling</h2>
    <label for="start-date">Start Date:</label>
    <input type="date" id="start-date">

    <table border="1">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
                <th>Saturday</th>
                <th>Sunday</th>
                <th>Normal Hours</th>
                <th>Normal Pay</th>
                <th>Saturday Hours</th>
                <th>Saturday Pay</th>
                <th>Sunday Hours</th>
                <th>Sunday Pay</th>
                <th>Total Hours</th>
                <th>Total Payroll</th>
            </tr>
        </thead>
        <tbody>
            <!-- Employees will be loaded dynamically -->
        </tbody>
    </table>

    <!-- Buttons -->
    <button onclick="saveSchedule()">Save Schedule</button>
    <button onclick="resetSchedule()">Reset Schedule</button>  <!-- Reset Button -->
    <button onclick="calculatePayroll()">Calculate Payroll</button>  <!-- Calculate Payroll Button -->
    <button onclick="generatePDF()">Print Schedule (PDF)</button>  <!-- Print PDF Button -->

</body>
</html>
